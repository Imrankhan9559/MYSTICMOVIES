{% extends "base.html" %}
{% block content %}
<section class="rounded-2xl border border-gray-800 bg-gradient-to-b from-gray-900 to-black p-5 sm:p-8 mb-6 relative overflow-hidden">
    {% if item.backdrop %}
    <div class="absolute inset-0 opacity-20" style="background-image:url('{{ item.backdrop }}'); background-size:cover; background-position:center;"></div>
    {% endif %}
    <div class="flex flex-col lg:flex-row gap-6">
        <div class="lg:w-64">
            {% if item.poster %}
            <img src="{{ item.poster }}" alt="{{ item.title }}" class="aspect-[2/3] rounded-xl border border-gray-800 object-cover w-full">
            {% else %}
            <div class="aspect-[2/3] rounded-xl border border-gray-800 bg-gray-950 flex items-center justify-center">
                <i class="fas fa-film text-yellow-400 text-5xl"></i>
            </div>
            {% endif %}
        </div>
        <div class="flex-1">
            <div class="flex items-center gap-2 text-xs uppercase tracking-widest text-yellow-400 mb-2">
                <span>{{ item.type }}</span>
                <span class="text-gray-600">•</span>
                <span>{{ item.quality }}</span>
                {% if item.year %}<span class="text-gray-600">•</span><span>{{ item.year }}</span>{% endif %}
            </div>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white">{{ item.title }}</h1>
            {% if item.description %}
            <p class="text-gray-300 mt-4 leading-7">{{ item.description }}</p>
            {% else %}
            <p class="text-gray-400 mt-4">No description available.</p>
            {% endif %}
            <div class="mt-5 flex flex-wrap gap-3">
                {% if user %}
                <button data-item-id="{{ item.id }}" id="watchlistToggle" class="px-5 py-2.5 rounded-full bg-gray-800 border border-gray-700 text-gray-100 hover:border-yellow-500">
                    <i class="fas fa-bookmark mr-2"></i>{{ "Remove Watchlist" if watchlisted else "Add Watchlist" }}
                </button>
                {% if item.trailer_url %}
                <a href="{{ item.trailer_url }}" target="_blank" class="px-5 py-2.5 rounded-full bg-gray-800 border border-gray-700 text-gray-100 hover:border-yellow-500">
                    <i class="fas fa-video mr-2"></i>Trailer
                </a>
                {% endif %}
                {% else %}
                <a href="/login" class="px-5 py-2.5 rounded-full bg-gray-800 border border-gray-700 text-gray-100 hover:border-yellow-500">Login to Watch</a>
                {% endif %}
            </div>
            <div class="mt-5 text-xs text-gray-400 flex flex-wrap gap-2">
                {% if item.director %}<span class="px-2 py-1 bg-gray-800 rounded">Director: {{ item.director }}</span>{% endif %}
                {% for g in item.genres or [] %}<span class="px-2 py-1 bg-gray-800 rounded">#{{ g }}</span>{% endfor %}
                {% for a in item.actors or [] %}<span class="px-2 py-1 bg-gray-800 rounded">{{ a }}</span>{% endfor %}
            </div>
        </div>
    </div>
</section>

{% if item.type == "movie" %}
<section class="rounded-2xl border border-gray-800 bg-gray-950 p-5 sm:p-8 mb-6">
    <h2 class="text-xl font-bold text-white mb-4">Download Options</h2>
    <div class="space-y-3">
        {% for q in qualities %}
        <div class="rounded-lg border border-gray-800 bg-gray-900 px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="text-sm text-white font-semibold">{{ q.label }}</div>
                <div class="text-xs text-gray-400">{{ (q.size / 1024 / 1024) | round(2) }} MB</div>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">
                {% if user %}
                <a href="{{ q.view_url }}" class="px-3 py-1.5 rounded bg-yellow-400 text-black text-xs font-bold">Watch</a>
                <a href="{{ q.download_url }}" class="px-3 py-1.5 rounded bg-gray-800 border border-gray-700 text-xs text-gray-100">Download</a>
                <a href="{{ q.watch_url }}" class="px-3 py-1.5 rounded bg-gray-800 border border-gray-700 text-xs text-gray-100">Watch Together</a>
                <a href="{{ q.telegram_url }}" class="px-3 py-1.5 rounded bg-gray-800 border border-gray-700 text-xs text-gray-100">Telegram</a>
                {% if is_admin %}
                <a href="{{ q.admin_url }}" class="px-3 py-1.5 rounded bg-gray-800 border border-gray-700 text-xs text-gray-100">Admin Player</a>
                {% endif %}
                {% else %}
                <a href="/login" class="px-3 py-1.5 rounded bg-gray-800 border border-gray-700 text-xs text-gray-100">Login to access</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if item.type == "series" %}
<section class="rounded-2xl border border-gray-800 bg-gray-950 p-5 sm:p-8 mb-6">
    <h2 class="text-xl font-bold text-white mb-4">Seasons</h2>
    {% for s in seasons %}
    <div class="rounded-lg border border-gray-800 bg-gray-900 px-4 py-3 mb-4">
        <div class="flex items-center justify-between">
            <div class="text-white font-semibold">Season {{ s.season }}</div>
            <a href="/content/season-download/{{ item.title|lower }}/{{ s.season }}" class="text-xs text-yellow-400 hover:text-yellow-300">Download Season</a>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
            {% for q in s.qualities %}
            <button class="season-quality-btn px-3 py-1.5 rounded bg-gray-800 border border-gray-700 text-xs text-gray-100" data-season="{{ s.season }}" data-quality="{{ q.label }}">
                {{ q.label }} | {{ (q.size / 1024 / 1024) | round(2) }} MB
            </button>
            {% endfor %}
        </div>
        <div class="mt-4 hidden season-episodes" id="season-{{ s.season }}">
            <div class="text-xs text-gray-400 mb-2">Episodes</div>
            <div class="space-y-2" id="season-{{ s.season }}-list"></div>
        </div>
    </div>
    {% endfor %}
</section>
{% endif %}

{% if user %}
<script>
const watchBtn = document.getElementById("watchlistToggle");
if (watchBtn) {
    watchBtn.addEventListener("click", async () => {
        const itemId = watchBtn.dataset.itemId;
        const res = await fetch(`/content/watchlist/toggle/${itemId}`, { method: "POST" });
        const data = await res.json();
        if (data.status === "added") {
            watchBtn.innerHTML = '<i class="fas fa-bookmark mr-2"></i>Remove Watchlist';
        } else if (data.status === "removed") {
            watchBtn.innerHTML = '<i class="fas fa-bookmark mr-2"></i>Add Watchlist';
        }
    });
}
</script>
{% endif %}

{% if item.type == "series" %}
<script>
const seasons = {{ seasons|tojson }};
const isAdmin = {{ "true" if is_admin else "false" }};
function renderEpisodes(seasonNo, quality) {
    const season = seasons.find(s => s.season === seasonNo);
    if (!season) return;
    const list = document.getElementById(`season-${seasonNo}-list`);
    const container = document.getElementById(`season-${seasonNo}`);
    list.innerHTML = "";
    const episodes = season.episodes || {};
    Object.keys(episodes).sort((a,b) => parseInt(a)-parseInt(b)).forEach(ep => {
        const variants = episodes[ep];
        if (!variants[quality]) return;
        const v = variants[quality];
        const row = document.createElement("div");
        row.className = "flex items-center justify-between rounded border border-gray-800 bg-black px-3 py-2";
        const viewUrl = v.view_url || "";
        const downloadUrl = v.download_url || "";
        const watchUrl = v.watch_url || "";
        const telegramUrl = v.telegram_url || "";
        const adminLink = isAdmin ? `<a href="/player/${v.file_id}" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-[10px] text-gray-100">Admin Player</a>` : "";
        row.innerHTML = `
            <div class="text-xs text-gray-200">Episode ${ep}</div>
            <div class="flex gap-2">
                {% if user %}
                <a href="${viewUrl}" class="px-2 py-1 rounded bg-yellow-400 text-black text-[10px] font-bold">Watch</a>
                <a href="${downloadUrl}" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-[10px] text-gray-100">Download</a>
                <a href="${watchUrl}" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-[10px] text-gray-100">Watch Together</a>
                <a href="${telegramUrl}" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-[10px] text-gray-100">Telegram</a>
                ${adminLink}
                {% else %}
                <a href="/login" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-[10px] text-gray-100">Login</a>
                {% endif %}
            </div>
        `;
        list.appendChild(row);
    });
    container.classList.remove("hidden");
}
document.querySelectorAll(".season-quality-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const seasonNo = parseInt(btn.dataset.season, 10);
        const quality = btn.dataset.quality;
        renderEpisodes(seasonNo, quality);
    });
});
</script>
{% endif %}
{% endblock %}
