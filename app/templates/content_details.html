{% extends "base.html" %}
{% block content %}
<section class="rounded-2xl border border-gray-800 bg-gradient-to-b from-gray-900 to-black p-5 sm:p-8 mb-6 relative overflow-hidden">
    {% if item.backdrop %}
    <div
        aria-hidden="true"
        class="absolute inset-0 opacity-20 pointer-events-none select-none z-0"
        style="background-image:url('{{ item.backdrop }}'); background-size:cover; background-position:center;">
    </div>
    {% endif %}
    <div class="flex flex-col lg:flex-row gap-6 relative z-10">
        <div class="lg:w-64">
            {% if item.poster %}
            <img src="{{ item.poster }}" alt="{{ item.title }}" class="aspect-[2/3] rounded-xl border border-gray-800 object-cover w-full">
            {% else %}
            <div class="aspect-[2/3] rounded-xl border border-gray-800 bg-gray-950 flex items-center justify-center">
                <i class="fas fa-film text-yellow-400 text-5xl"></i>
            </div>
            {% endif %}
        </div>
        <div class="flex-1">
            <div class="flex items-center gap-2 text-xs uppercase tracking-widest text-yellow-400 mb-2">
                <span>{{ item.type }}</span>
                <span class="text-gray-600">•</span>
                <span>{{ item.quality }}</span>
                {% if item.year %}<span class="text-gray-600">•</span><span>{{ item.year }}</span>{% endif %}
                {% if item.release_date %}<span class="text-gray-600">•</span><span>{{ item.release_date }}</span>{% endif %}
            </div>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white">{{ item.title }}</h1>
            {% if item.description %}
            <p class="text-gray-300 mt-4 leading-7">{{ item.description }}</p>
            {% else %}
            <p class="text-gray-400 mt-4">No description available.</p>
            {% endif %}
            <div class="mt-5 flex flex-wrap gap-3">
                {% if user %}
                <button type="button" data-item-id="{{ item.id }}" id="watchlistToggle" class="px-5 py-2.5 rounded-full bg-gray-800 border border-gray-700 text-gray-100 hover:border-yellow-500 cursor-pointer relative z-20">
                    <i class="fas fa-bookmark mr-2"></i>{{ "Remove Watchlist" if watchlisted else "Add Watchlist" }}
                </button>
                {% else %}
                <a href="/login" class="px-5 py-2.5 rounded-full bg-gray-800 border border-gray-700 text-gray-100 hover:border-yellow-500 cursor-pointer relative z-20">Login to Watch</a>
                {% endif %}
                {% if item.trailer_embed or item.trailer_url %}
                <a id="trailerJumpBtn" href="#trailer" class="px-5 py-2.5 rounded-full bg-gray-800 border border-gray-700 text-gray-100 hover:border-yellow-500 cursor-pointer relative z-20">
                    <i class="fas fa-video mr-2"></i>Trailer
                </a>
                {% endif %}
            </div>
            <div class="mt-5 text-xs text-gray-400 flex flex-wrap gap-2">
                {% if item.director %}<span class="px-2 py-1 bg-gray-800 rounded">Director: {{ item.director }}</span>{% endif %}
                {% if item.industry_label %}<span class="px-2 py-1 bg-gray-800 rounded">Industry: {{ item.industry_label }}</span>{% endif %}
                {% for g in item.genres or [] %}<span class="px-2 py-1 bg-gray-800 rounded">#{{ g }}</span>{% endfor %}
            </div>

            {% if item.cast_profiles and item.cast_profiles|length > 0 %}
            <div class="mt-6">
                <h3 class="text-sm font-semibold text-white mb-3">Cast</h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                    {% for c in item.cast_profiles %}
                    <a
                        href="/content/cast?name={{ c.name | urlencode }}{% if c.id %}&tmdb_id={{ c.id }}{% endif %}&back={{ request.url.path | urlencode }}"
                        class="flex items-center gap-3 rounded-lg border border-gray-800 bg-gray-900/60 p-2 hover:border-yellow-500 transition cursor-pointer relative z-20">
                        <div class="h-12 w-12 rounded-full overflow-hidden border border-gray-700 bg-gray-800 flex items-center justify-center">
                            {% if c.image %}
                            <img src="{{ c.image }}" alt="{{ c.name }}" class="h-full w-full object-cover">
                            {% else %}
                            <span class="text-xs text-gray-300 font-semibold">{{ c.name[:1] }}</span>
                            {% endif %}
                        </div>
                        <div class="min-w-0">
                            <div class="text-sm text-gray-100 truncate">{{ c.name }}</div>
                            {% if c.role %}
                            <div class="text-[11px] text-gray-400 truncate">{{ c.role }}</div>
                            {% endif %}
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% elif item.actors %}
            <div class="mt-6">
                <h3 class="text-sm font-semibold text-white mb-3">Cast</h3>
                <div class="flex flex-wrap gap-2 text-xs text-gray-300">
                    {% for a in item.actors or [] %}
                    <a href="/content/cast?name={{ a | urlencode }}&back={{ request.url.path | urlencode }}" class="px-2 py-1 bg-gray-800 rounded hover:border-yellow-500 border border-gray-700 cursor-pointer relative z-20">{{ a }}</a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if item.trailer_embed or item.trailer_url %}
            <div class="mt-6" id="trailer">
                <h3 class="text-sm font-semibold text-white mb-3">Trailer</h3>
                {% if item.trailer_embed %}
                <div class="aspect-video rounded-xl overflow-hidden border border-gray-800 bg-black">
                    <iframe
                        id="trailerPlayer"
                        data-base-src="https://www.youtube-nocookie.com/embed/{{ item.trailer_embed }}?rel=0&modestbranding=1&playsinline=1"
                        src="https://www.youtube-nocookie.com/embed/{{ item.trailer_embed }}?rel=0&modestbranding=1&playsinline=1"
                        title="Trailer"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                        loading="lazy"
                        class="w-full h-full">
                    </iframe>
                </div>
                {% elif item.trailer_url %}
                <a href="{{ item.trailer_url }}" target="_blank" class="inline-flex items-center px-4 py-2 rounded-full bg-gray-800 border border-gray-700 text-sm text-gray-100 hover:border-yellow-500">
                    <i class="fas fa-video mr-2"></i>Watch Trailer
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</section>

{% if item.type == "movie" %}
<section class="rounded-2xl border border-gray-800 bg-gray-950 p-5 sm:p-8 mb-6">
    <h2 class="text-xl font-bold text-white mb-4">Download Options</h2>
    <div class="space-y-3">
        {% for q in qualities %}
        <div class="rounded-lg border border-gray-800 bg-gray-900 px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="text-sm text-white font-semibold">{{ q.label }}</div>
                <div class="text-xs text-gray-400">{{ q.size_label }}</div>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">
                {% if user %}
                <a href="{{ q.view_url }}" class="px-3 py-1.5 rounded bg-yellow-400 text-black text-xs font-bold">Watch</a>
                <a href="{{ q.download_url }}" class="px-3 py-1.5 rounded bg-gray-800 border border-gray-700 text-xs text-gray-100">Download</a>
                <a href="{{ q.watch_url }}" class="px-3 py-1.5 rounded bg-gray-800 border border-gray-700 text-xs text-gray-100">Watch Together</a>
                <a href="{{ q.telegram_url }}" class="px-3 py-1.5 rounded bg-gray-800 border border-gray-700 text-xs text-gray-100">Telegram</a>
                {% if is_admin %}
                <a href="{{ q.admin_url }}" class="px-3 py-1.5 rounded bg-gray-800 border border-gray-700 text-xs text-gray-100">Admin Player</a>
                {% endif %}
                {% else %}
                <a href="/login" class="px-3 py-1.5 rounded bg-gray-800 border border-gray-700 text-xs text-gray-100">Login to access</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if item.type == "series" %}
<section class="rounded-2xl border border-gray-800 bg-gray-950 p-5 sm:p-8 mb-6">
    <h2 class="text-xl font-bold text-white mb-4">Seasons & Episodes</h2>
    {% if seasons and seasons|length > 0 %}
    <div class="space-y-4">
        {% for s in seasons %}
        <details class="rounded-lg border border-gray-800 bg-gray-900 px-4 py-3">
            <summary class="cursor-pointer list-none flex items-center justify-between gap-3">
                <div class="text-white font-semibold">Season {{ s.season }}</div>
                <div class="text-xs text-gray-400">
                    {{ s.episode_count }} Episodes
                    {% if s.qualities and s.qualities|length > 0 %}
                    | {{ s.qualities|join(", ") }}
                    {% endif %}
                </div>
            </summary>
            <div class="mt-4 space-y-3">
                {% for ep in s.episodes %}
                <details class="rounded border border-gray-800 bg-black px-3 py-2">
                    <summary class="cursor-pointer list-none flex items-center justify-between gap-2">
                        <div class="text-sm text-gray-100">
                            Episode {{ ep.episode }}
                            {% if ep.title %} - {{ ep.title }}{% endif %}
                        </div>
                        <div class="text-xs text-gray-400">
                            {{ ep.quality_count }} qualities | {{ ep.display_size_label }}
                        </div>
                    </summary>
                    <div class="mt-3 space-y-2">
                        {% for q in ep.qualities %}
                        <div class="rounded border border-gray-800 bg-gray-950 px-3 py-2">
                            <div class="flex items-center justify-between">
                                <div class="text-xs font-semibold text-white">{{ q.label }}</div>
                                <div class="text-[11px] text-gray-400">{{ q.size_label }}</div>
                            </div>
                            <div class="mt-2 flex flex-wrap gap-2">
                                {% if user %}
                                <a href="{{ q.view_url }}" class="px-2 py-1 rounded bg-yellow-400 text-black text-[10px] font-bold">Watch</a>
                                <a href="{{ q.download_url }}" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-[10px] text-gray-100">Download</a>
                                <a href="{{ q.watch_url }}" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-[10px] text-gray-100">Watch Together</a>
                                <a href="{{ q.telegram_url }}" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-[10px] text-gray-100">Telegram</a>
                                {% if is_admin %}
                                <a href="{{ q.admin_url }}" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-[10px] text-gray-100">Admin Player</a>
                                {% endif %}
                                {% else %}
                                <a href="/login" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-[10px] text-gray-100">Login to access</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </details>
                {% endfor %}
            </div>
        </details>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-sm text-gray-400">No episodes available for this series yet.</div>
    {% endif %}
</section>
{% endif %}

{% if related_cards and related_cards|length > 0 %}
<section class="rounded-2xl border border-gray-800 bg-gray-950 p-5 sm:p-8 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <div>
            <h2 class="text-xl font-bold text-white">Related Content</h2>
            <p class="text-xs text-gray-400 mt-1">Matched by genres, cast, director, year and industry.</p>
        </div>
        <div class="text-xs text-gray-400">{{ related_cards|length }} recommendations</div>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
        {% for rel in related_cards %}
        <a href="/content/details/{{ rel.slug or rel.id }}" class="group rounded-2xl border border-gray-800 bg-black/70 overflow-hidden hover:border-yellow-500/60 transition">
            <div class="relative aspect-[2/3]">
                {% if rel.poster %}
                <img src="{{ rel.poster }}" alt="{{ rel.title }}" class="h-full w-full object-cover">
                {% else %}
                <div class="h-full w-full bg-gradient-to-br from-gray-900 via-black to-gray-800 flex items-center justify-center">
                    <i class="fas fa-film text-yellow-400 text-4xl"></i>
                </div>
                {% endif %}
                <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/25 to-transparent"></div>
                <div class="absolute bottom-0 left-0 right-0 p-3">
                    <div class="text-[10px] uppercase tracking-widest text-yellow-400">{{ rel.type }}</div>
                    <div class="text-sm font-semibold text-white line-clamp-2">{{ rel.title }}</div>
                    <div class="text-[11px] text-gray-400 mt-1">
                        {% if rel.year %}{{ rel.year }}{% else %}-{% endif %} | {{ rel.industry_label }}
                    </div>
                </div>
            </div>
            <div class="p-2 space-y-1">
                {% for tag in rel.match_tags %}
                <div class="text-[10px] text-gray-400 truncate">{{ tag }}</div>
                {% endfor %}
            </div>
        </a>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if user %}
<script>
const watchBtn = document.getElementById("watchlistToggle");
if (watchBtn) {
    watchBtn.addEventListener("click", async () => {
        const itemId = watchBtn.dataset.itemId;
        try {
            watchBtn.disabled = true;
            const res = await fetch(`/content/watchlist/toggle/${encodeURIComponent(itemId)}`, { method: "POST", credentials: "same-origin" });
            if (!res.ok) {
                if (res.status === 401) {
                    window.location.href = "/login";
                    return;
                }
                alert("Could not update watchlist.");
                return;
            }
            const data = await res.json();
            if (data.status === "added") {
                watchBtn.innerHTML = '<i class="fas fa-bookmark mr-2"></i>Remove Watchlist';
            } else if (data.status === "removed") {
                watchBtn.innerHTML = '<i class="fas fa-bookmark mr-2"></i>Add Watchlist';
            }
        } catch (e) {
            alert("Network error while updating watchlist.");
            return;
        } finally {
            watchBtn.disabled = false;
        }
    });
}
</script>
{% endif %}
{% if item.trailer_embed %}
<script>
const trailerJumpBtn = document.getElementById("trailerJumpBtn");
const trailerSection = document.getElementById("trailer");
const trailerPlayer = document.getElementById("trailerPlayer");

if (trailerJumpBtn && trailerSection) {
    trailerJumpBtn.addEventListener("click", (event) => {
        event.preventDefault();
        trailerSection.scrollIntoView({ behavior: "smooth", block: "start" });
        if (!trailerPlayer) return;
        const baseSrc = trailerPlayer.dataset.baseSrc || trailerPlayer.getAttribute("src") || "";
        if (!baseSrc) return;
        const srcHasAutoplay = /[?&]autoplay=1(?:&|$)/.test(baseSrc);
        if (srcHasAutoplay) {
            trailerPlayer.src = baseSrc;
            return;
        }
        const joiner = baseSrc.includes("?") ? "&" : "?";
        trailerPlayer.src = `${baseSrc}${joiner}autoplay=1`;
    });
}
</script>
{% endif %}
{% endblock %}
