{% extends "base.html" %}
{% block content %}
<style>
    :root {
        --bg-body: #050505;
        --bg-card: #111111;
        --bg-input: #0f0f0f;
        --border-color: #222;
        --gold-primary: #d4af37;
        --gold-glow: rgba(212, 175, 55, 0.25);
        --text-main: #ffffff;
        --text-muted: #888888;
    }
    .content-shell {
        margin-left: calc(50% - 50vw);
        margin-right: calc(50% - 50vw);
    }
    .hero-section {
        margin-top: 8px;
        padding: 46px 20px;
        background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        border-bottom: 1px solid var(--border-color);
        position: relative;
    }
    .search-wrapper-outer {
        max-width: 880px;
        margin: 0 auto;
        position: relative;
        text-align: center;
    }
    .filter-btn-group {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 14px;
        margin-bottom: 24px;
    }
    .filter-btn {
        background: transparent;
        border: 1px solid #333;
        color: #aaa;
        padding: 10px 24px;
        border-radius: 50px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .filter-btn:hover,
    .filter-btn.active {
        background: var(--gold-primary);
        color: #000;
        border-color: var(--gold-primary);
        box-shadow: 0 0 20px var(--gold-glow);
        transform: translateY(-2px);
    }
    .search-bar-container {
        display: flex;
        align-items: center;
        background: var(--bg-input);
        border: 1px solid #333;
        border-radius: 50px;
        padding: 6px 6px 6px 18px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        transition: all 0.3s ease;
        max-width: 760px;
        margin: 0 auto;
    }
    .search-bar-container:focus-within {
        border-color: var(--gold-primary);
        box-shadow: 0 0 25px var(--gold-glow);
    }
    .search-input {
        flex: 1;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 16px;
        padding: 10px 14px;
        font-weight: 500;
    }
    .search-btn {
        background: var(--gold-primary);
        color: #000;
        border: none;
        padding: 12px 32px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 14px;
        text-transform: uppercase;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 9px;
        transition: 0.2s;
        white-space: nowrap;
    }
    .search-btn:hover {
        background: #fff;
        transform: scale(1.05);
    }
    .loading-dots {
        display: none;
        gap: 4px;
        margin-right: 14px;
    }
    .loading-dots span {
        width: 6px;
        height: 6px;
        background: var(--gold-primary);
        border-radius: 50%;
        animation: bounce 0.5s infinite alternate;
    }
    .loading-dots span:nth-child(2) { animation-delay: 0.1s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.2s; }
    @keyframes bounce {
        to { transform: translateY(-5px); opacity: 0.5; }
    }
    .tags-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 24px;
    }
    .tag-pill {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid #333;
        color: var(--text-muted);
        padding: 6px 15px;
        border-radius: 15px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.25s ease;
    }
    .tag-pill:hover {
        border-color: var(--gold-primary);
        color: var(--gold-primary);
    }
    .catalog-section {
        padding: 42px 0 88px;
        min-height: 80vh;
    }
    .catalog-container {
        width: min(1240px, calc(100vw - 40px));
        margin: 0 auto;
    }
    .catalog-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        gap: 12px;
    }
    .catalog-title {
        color: #fff;
        font-size: 24px;
        font-weight: 600;
        border-left: 4px solid var(--gold-primary);
        padding-left: 14px;
    }
    .catalog-count {
        color: #666;
        font-size: 13px;
    }
    .catalog-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
    }
    @media (min-width: 768px) {
        .catalog-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (min-width: 1024px) {
        .catalog-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    .movie-card {
        background: var(--bg-card);
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.3s ease;
        position: relative;
        border: 1px solid transparent;
    }
    .movie-card:hover {
        transform: translateY(-8px);
        border-color: var(--gold-primary);
        z-index: 4;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
    }
    .poster-wrapper {
        position: relative;
        padding-top: 150%;
        background: #000;
        overflow: hidden;
    }
    .poster-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: 0.5s;
        opacity: 0;
    }
    .poster-image.loaded { opacity: 1; }
    .movie-card:hover .poster-image {
        transform: scale(1.1);
        filter: brightness(0.7);
    }
    .card-details { padding: 14px; }
    .card-title {
        color: #e0e0e0;
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 5px;
    }
    .card-category {
        color: var(--gold-primary);
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 8px;
    }
    .meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        min-height: 24px;
    }
    .meta-row.quality-row {
        flex-wrap: nowrap;
        overflow: hidden;
    }
    .quality-pill {
        border: 1px solid rgba(212, 175, 55, 0.5);
        color: #f1d479;
        background: rgba(212, 175, 55, 0.1);
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.3px;
    }
    .season-line {
        color: #b7b7b7;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .empty-state {
        text-align: center;
        padding: 70px 20px;
        color: #8d8d8d;
        border: 1px solid #242424;
        border-radius: 12px;
        background: rgba(16, 16, 16, 0.7);
    }
    .pagination-bar {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 48px;
        flex-wrap: wrap;
    }
    .page-link-custom {
        min-width: 40px;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 12px;
        background: #111;
        border: 1px solid #333;
        color: #fff;
        border-radius: 8px;
        transition: 0.2s;
        text-decoration: none;
        font-size: 13px;
        font-weight: 600;
    }
    .page-link-custom:hover,
    .page-link-custom.active {
        background: var(--gold-primary);
        color: #000;
        border-color: var(--gold-primary);
    }
    #dynamic-search-dropdown {
        position: absolute;
        z-index: 200;
        background: #111;
        border: 1px solid var(--gold-primary);
        border-top: none;
        border-radius: 0 0 15px 15px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
        overflow: hidden;
        display: none;
        text-align: left;
    }
    .search-item {
        padding: 10px;
        border-bottom: 1px solid #222;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #fff;
        text-decoration: none;
    }
    .search-item:hover { background: #222; }
    .search-item img {
        width: 40px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        flex-shrink: 0;
    }
    .search-item-fallback {
        width: 40px;
        height: 60px;
        border-radius: 4px;
        border: 1px solid #444;
        background: #1b1b1b;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #d4af37;
    }
    @media (max-width: 768px) {
        .hero-section {
            margin-top: 6px;
            padding: 30px 15px;
        }
        .search-btn span { display: none; }
        .search-btn {
            width: 50px;
            padding: 0;
            justify-content: center;
        }
        .filter-btn {
            padding: 8px 14px;
            font-size: 11px;
        }
        .catalog-title { font-size: 20px; }
        .catalog-container {
            width: min(1240px, calc(100vw - 28px));
        }
    }
</style>

<section class="content-shell">
    <div class="hero-section">
        <div class="search-wrapper-outer">
            <div class="filter-btn-group">
                <a href="/content/f/all" class="filter-btn {{ 'active' if filter_type == 'all' else '' }}">All Content</a>
                <a href="/content/f/movies" class="filter-btn {{ 'active' if filter_type == 'movies' else '' }}">Movies</a>
                <a href="/content/f/series" class="filter-btn {{ 'active' if filter_type == 'series' else '' }}">Web Series</a>
            </div>

            <div class="search-bar-container" id="searchBarContainer">
                <i class="fas fa-search text-gray-500 ml-2"></i>
                <input
                    type="text"
                    id="mainInput"
                    class="search-input"
                    placeholder="Search in {{ filter_type|capitalize }}..."
                    value="{{ search_query or '' }}"
                    autocomplete="off">

                <div class="loading-dots" id="loadingDots"><span></span><span></span><span></span></div>

                <button id="mainSearchBtn" class="search-btn" type="button">
                    <span>Search</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <div id="dynamic-search-dropdown"></div>

            <div class="tags-container">
                <a href="/content/f/{{ filter_type }}/search_content/Bollywood" class="tag-pill">Bollywood</a>
                <a href="/content/f/{{ filter_type }}/search_content/Hollywood" class="tag-pill">Hollywood</a>
                <a href="/content/f/{{ filter_type }}/search_content/Anime" class="tag-pill">Anime</a>
                <a href="/content/f/{{ filter_type }}/search_content/Netflix" class="tag-pill">Netflix</a>
                <a href="/content/f/{{ filter_type }}/search_content/2025" class="tag-pill">2025</a>
            </div>
        </div>
    </div>

    <div class="catalog-section">
        <div class="catalog-container">
            <div class="catalog-header">
                <div class="catalog-title">{{ title }}</div>
                <div class="catalog-count">{{ "{:,}".format(total_items or 0) }} Items</div>
            </div>

            {% if cards and cards|length > 0 %}
            <div class="catalog-grid">
                {% for item in cards %}
                <a href="/content/details/{{ item.slug }}" class="block">
                    <div class="movie-card">
                        <div class="poster-wrapper">
                            {% if item.poster %}
                            <img
                                src="{{ item.poster }}"
                                class="poster-image"
                                alt="{{ item.title }}"
                                loading="lazy"
                                onload="this.classList.add('loaded')"
                                onerror="this.onerror=null;this.src='https://placehold.co/600x900/131313/f5f5f5?text=No+Poster';this.classList.add('loaded');">
                            {% else %}
                            <img
                                src="https://placehold.co/600x900/131313/f5f5f5?text=No+Poster"
                                class="poster-image loaded"
                                alt="{{ item.title }}"
                                loading="lazy">
                            {% endif %}
                        </div>
                        <div class="card-details">
                            <div class="card-title">{{ item.title }}</div>
                            <div class="card-category">{{ "Movie" if item.type == "movie" else "Web Series" }}</div>

                            {% if item.type == "movie" %}
                            <div class="meta-row quality-row">
                                {% if item.quality_row and item.quality_row|length > 0 %}
                                    {% for q in item.quality_row %}
                                    <span class="quality-pill">{{ q }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="season-line">Quality: HD</span>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="meta-row">
                                <span class="season-line">{{ item.season_text or "Season: 1" }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-circle-exclamation text-4xl text-gray-700"></i>
                <h3 class="mt-4 text-2xl text-gray-200">No Results Found</h3>
                <p class="mt-2 text-sm text-gray-400">We could not find anything matching your request.</p>
                <a href="/content/f/all" class="tag-pill mt-4 inline-block">Reset Filter</a>
            </div>
            {% endif %}

            {% if total_pages and total_pages > 1 %}
            <div class="pagination-bar">
                {% if current_page > 1 %}
                <a href="{{ page_base_url }}?page={{ current_page - 1 }}" class="page-link-custom"><i class="fas fa-chevron-left"></i></a>
                {% endif %}

                {% for i in range(page_start, page_end + 1) %}
                <a href="{{ page_base_url }}?page={{ i }}" class="page-link-custom {{ 'active' if i == current_page else '' }}">{{ i }}</a>
                {% endfor %}

                {% if current_page < total_pages %}
                <a href="{{ page_base_url }}?page={{ current_page + 1 }}" class="page-link-custom"><i class="fas fa-chevron-right"></i></a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("mainInput");
    const inputContainer = document.getElementById("searchBarContainer");
    const loadingDots = document.getElementById("loadingDots");
    const mainBtn = document.getElementById("mainSearchBtn");
    const dropdown = document.getElementById("dynamic-search-dropdown");
    const filterType = "{{ filter_type or 'all' }}";
    let debounceTimer;

    function repositionDropdown() {
        if (!dropdown || dropdown.style.display === "none") return;
        const rect = inputContainer.getBoundingClientRect();
        const scrollY = window.pageYOffset || document.documentElement.scrollTop;
        dropdown.style.top = (rect.bottom + scrollY + 2) + "px";
        dropdown.style.left = rect.left + "px";
        dropdown.style.width = rect.width + "px";
    }

    function executeSearch() {
        const q = (input?.value || "").trim();
        if (!q) return;
        window.location.href = `/content/f/${encodeURIComponent(filterType)}/search_content/${encodeURIComponent(q)}`;
    }

    if (mainBtn) mainBtn.addEventListener("click", executeSearch);
    if (input) {
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") executeSearch();
        });

        input.addEventListener("input", function () {
            const query = this.value.trim();
            clearTimeout(debounceTimer);
            if (!dropdown) return;
            if (query.length < 2) {
                dropdown.style.display = "none";
                loadingDots.style.display = "none";
                return;
            }
            loadingDots.style.display = "flex";

            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`/content/search/suggestions?q=${encodeURIComponent(query)}`, { credentials: "same-origin" });
                    const data = await res.json();
                    loadingDots.style.display = "none";

                    if (!data.items || data.items.length === 0) {
                        dropdown.style.display = "none";
                        return;
                    }

                    dropdown.innerHTML = data.items.map((item) => {
                        const title = (item.title || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        const year = (item.year || "-").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        const type = ((item.type || "").toUpperCase()).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        const url = `/content/details/${encodeURIComponent(item.slug || "")}`;
                        const poster = item.poster
                            ? `<img src="${item.poster}" alt="${title}" loading="lazy">`
                            : `<div class="search-item-fallback"><i class="fas fa-film"></i></div>`;
                        return `
                            <a href="${url}" class="search-item">
                                ${poster}
                                <div class="min-w-0">
                                    <div class="text-sm text-white truncate">${title}</div>
                                    <div class="text-xs text-gray-400">${year} | ${type}</div>
                                </div>
                            </a>
                        `;
                    }).join("");

                    dropdown.style.display = "block";
                    repositionDropdown();
                } catch (e) {
                    loadingDots.style.display = "none";
                    dropdown.style.display = "none";
                }
            }, 260);
        });
    }

    window.addEventListener("scroll", repositionDropdown);
    window.addEventListener("resize", repositionDropdown);
    document.addEventListener("click", function (e) {
        if (!dropdown || !inputContainer) return;
        if (!inputContainer.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = "none";
        }
    });
});
</script>
{% endblock %}
