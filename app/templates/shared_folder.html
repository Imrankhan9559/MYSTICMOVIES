{% extends "base.html" %}
{% block content %}

<div id="publicApp" class="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-4" data-token="{{ token }}" data-username="{{ viewer_name }}" data-item-id="{{ item.id }}">
    <div id="viewerGate" class="viewer-gate hidden">
        <div class="viewer-card">
            <div class="viewer-title">Who's watching?</div>
            <div class="viewer-sub">Enter your name to save progress and resume later.</div>
            <input id="viewerInput" type="text" placeholder="Your name" class="viewer-input" />
            <button id="viewerSubmit" class="viewer-btn">Continue</button>
            <div id="viewerHint" class="viewer-hint"></div>
        </div>
    </div>
    
    <div class="w-full max-w-4xl bg-gray-800 rounded-xl shadow-2xl overflow-hidden border border-gray-700 relative">
        
        <div class="bg-gray-900 p-4 border-b border-gray-700 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="flex items-center text-white">
                <i class="fas {{ item.icon }} text-red-500 text-2xl mr-3"></i>
                <div>
                    <h1 class="font-bold text-lg truncate max-w-full sm:max-w-md">{{ item.name }}</h1>
                    <p class="text-xs text-gray-400">Shared via MorganXMystic Cloud</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-2 w-full sm:w-auto justify-start sm:justify-end">
                <a href="{{ stream_url }}" download="{{ item.name }}" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold transition shadow-lg w-full sm:w-auto text-center">
                    <i class="fas fa-download mr-1"></i> Download
                </a>
                {% if bot_username and item.share_token %}
                <a href="https://t.me/{{ bot_username }}?start=share_{{ item.share_token }}" target="_blank" class="bg-blue-700 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold transition shadow-lg w-full sm:w-auto text-center">
                    <i class="fab fa-telegram mr-1"></i> Telegram
                </a>
                {% endif %}
            </div>
        </div>

        <div class="bg-black min-h-[260px] sm:min-h-[400px] flex flex-col lg:flex-row relative group">
            <div class="flex-1 flex justify-center items-center">
                {% if "video" in item.mime_type or item.name.lower().endswith(('.mp4', '.mkv', '.webm', '.mov', '.avi')) %}
                    <video id="publicPlayer" controls autoplay preload="auto" data-hls="{{ hls_url or '' }}" class="w-full max-h-[70vh] outline-none">
                        <source src="{{ stream_url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                
                {% elif "image" in item.mime_type or item.name.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                    <img src="{{ stream_url }}" alt="{{ item.name }}" class="max-w-full max-h-[70vh] object-contain">
                
                {% elif "audio" in item.mime_type or item.name.lower().endswith(('.mp3', '.wav', '.ogg', '.m4a')) %}
                    <div class="text-center p-10">
                        <div class="w-24 h-24 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner animate-pulse">
                            <i class="fas fa-music text-4xl text-red-500"></i>
                        </div>
                        <audio controls autoplay class="w-full max-w-md">
                            <source src="{{ stream_url }}" type="audio/mpeg">
                        </audio>
                    </div>

                {% else %}
                    <div class="text-center p-10">
                        <i class="fas fa-file-archive text-6xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400 text-lg">Preview not available</p>
                        <p class="text-sm text-gray-500 mb-6">{{ item.formatted_size }}</p>
                        <a href="{{ stream_url }}" class="bg-red-600 hover:bg-red-500 text-white px-8 py-3 rounded-full font-bold text-lg transition shadow-red-glow">
                            Download File
                        </a>
                    </div>
                {% endif %}
            </div>

            <div class="w-full lg:w-80 bg-gray-900 border-t lg:border-t-0 lg:border-l border-gray-800 max-h-[70vh] overflow-y-auto">
                <div class="px-4 py-3 text-xs uppercase tracking-wider text-gray-400 border-b border-gray-800">
                    Episodes
                </div>
                <div class="p-3 space-y-2">
                    {% for ep in episodes %}
                        {% set viewer_q = ("&u=" ~ viewer_name) if viewer_name else "" %}
                        <a href="/s/{{ token }}?e={{ ep.id }}{{ viewer_q }}" class="flex items-center gap-3 p-2 rounded-lg transition border {% if ep.id|string == item.id|string %}bg-gray-800 border-red-500{% else %}bg-gray-900 border-gray-800 hover:border-gray-600{% endif %}">
                            <div class="w-9 h-9 rounded bg-gray-800 flex items-center justify-center">
                                <i class="fas {{ ep.icon }} text-red-500"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm text-white truncate">{{ ep.name }}</div>
                                <div class="text-[11px] text-gray-500">{{ ep.formatted_size }}</div>
                            </div>
                            {% if ep.id|string == item.id|string %}
                                <span class="text-[10px] text-red-400 font-semibold">PLAYING</span>
                            {% endif %}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="bg-gray-900 p-4 border-t border-gray-700 flex flex-col md:flex-row md:items-center gap-4">
            <div class="flex-1 text-xs text-gray-400">Shared via MorganXMystic</div>
            <div class="flex flex-wrap gap-2 w-full md:w-auto md:justify-end">
                <select id="publicQuality" class="bg-gray-800 border border-gray-700 text-white text-xs rounded px-3 py-2 w-full sm:w-auto">
                    <option value="-1">Quality: Original</option>
                </select>
                <select id="publicSubtitle" class="bg-gray-800 border border-gray-700 text-white text-xs rounded px-3 py-2 w-full sm:w-auto">
                    <option value="-1">Subtitles: Off</option>
                </select>
                <select id="publicAudio" class="bg-gray-800 border border-gray-700 text-white text-xs rounded px-3 py-2 w-full sm:w-auto">
                    <option value="-1">Audio: Default</option>
                </select>
                <select id="publicSpeed" class="bg-gray-800 border border-gray-700 text-white text-xs rounded px-3 py-2 w-full sm:w-auto">
                    <option value="1">Speed: 1x</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x</option>
                </select>
            </div>
        </div>

        <div class="bg-gray-800 p-4 border-t border-gray-700 text-sm text-gray-400 flex flex-col sm:flex-row sm:justify-between gap-2">
            <span>Size: <span class="text-white">{{ item.formatted_size }}</span></span>
            <span>Type: <span class="text-white uppercase">{{ item.mime_type.split('/')[1] if '/' in item.mime_type else 'FILE' }}</span></span>
        </div>
    </div>

    <div class="mt-8 w-full max-w-4xl transform hover:scale-[1.01] transition duration-300">
        <div class="bg-gradient-to-r from-red-900 to-black p-1 rounded-xl shadow-lg">
            <div class="bg-gray-900 rounded-lg p-6 flex flex-col md:flex-row items-center justify-between">
                <div class="mb-4 md:mb-0 text-center md:text-left">
                    <h2 class="text-2xl font-bold text-white mb-1">
                        {{ banner_title or "Enjoy streaming securely" }}
                    </h2>
                    <p class="text-gray-400 text-sm">
                        {{ banner_sub or "Access your content from anywhere." }}
                    </p>
                </div>
                
                {% if not hide_auth %}
                <a href="{{ banner_link or '/login' }}" class="group relative px-8 py-3 bg-red-600 rounded-full text-white font-bold overflow-hidden shadow-lg transition-all hover:bg-red-500 hover:shadow-red-500/50">
                    <span class="relative z-10 flex items-center">
                        Create Free Account <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition"></i>
                    </span>
                    <div class="absolute top-0 -left-full w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 group-hover:animate-shine"></div>
                </a>
                {% endif %}
            </div>
        </div>
    </div>

</div>

<style>
    @keyframes shine {
        100% { left: 125%; }
    }
    .group-hover\:animate-shine:hover {
        animation: shine 0.75s;
    }

    .viewer-gate {
        position: fixed;
        inset: 0;
        background: rgba(5, 6, 12, 0.92);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 60;
        backdrop-filter: blur(10px);
    }

    .viewer-gate.hidden {
        display: none;
    }

    .viewer-card {
        width: min(420px, 90vw);
        background: rgba(17, 24, 39, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 18px;
        padding: 24px;
        text-align: center;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
    }

    .viewer-title {
        font-size: 20px;
        font-weight: 700;
        color: #fff;
    }

    .viewer-sub {
        margin-top: 8px;
        font-size: 13px;
        color: #9aa4b2;
    }

    .viewer-input {
        margin-top: 16px;
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(5, 8, 18, 0.9);
        color: #fff;
        font-size: 14px;
    }

    .viewer-btn {
        width: 100%;
        justify-content: center;
        margin-top: 12px;
        padding: 10px 18px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 13px;
        background: #e50914;
        color: #fff;
        border: none;
        box-shadow: 0 10px 30px rgba(229, 9, 20, 0.35);
        cursor: pointer;
    }

    .viewer-hint {
        margin-top: 10px;
        font-size: 12px;
        color: #9aa4b2;
    }

    @media (max-width: 480px) {
        .viewer-card { padding: 18px; }
        .viewer-title { font-size: 18px; }
        .viewer-sub { font-size: 12px; }
    }

</style>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
const publicApp = document.getElementById("publicApp");
const token = publicApp.dataset.token;
const viewerName = publicApp.dataset.username;
const params = new URLSearchParams(window.location.search);
const currentEpisode = params.get("e");

const viewerGate = document.getElementById("viewerGate");
const viewerInput = document.getElementById("viewerInput");
const viewerSubmit = document.getElementById("viewerSubmit");
const viewerHint = document.getElementById("viewerHint");

function openViewerGate() {
    if (!viewerGate) return;
    viewerGate.classList.remove("hidden");
    viewerInput?.focus();
}

async function resolveViewerName(rawName) {
    const res = await fetch(`/s/resolve_user?name=${encodeURIComponent(rawName)}`);
    const data = await res.json();
    if (data.exists) {
        viewerHint.textContent = `Matched: ${data.resolved}`;
    } else {
        viewerHint.textContent = "New viewer saved as guest.";
    }
    return data.resolved || rawName;
}

if (viewerName) {
    viewerGate?.classList.add("hidden");
} else {
    openViewerGate();
}

viewerSubmit?.addEventListener("click", async () => {
    const raw = (viewerInput?.value || "").trim();
    if (!raw) return;
    const resolved = await resolveViewerName(raw);
    const episodePart = currentEpisode ? `&e=${encodeURIComponent(currentEpisode)}` : "";
    window.location.href = `/s/${token}?u=${encodeURIComponent(resolved)}${episodePart}`;
});

const itemId = publicApp.dataset.itemId;
const player = document.getElementById("publicPlayer");
const qualitySelect = document.getElementById("publicQuality");
const subtitleSelect = document.getElementById("publicSubtitle");
const audioSelect = document.getElementById("publicAudio");

function resetPublicTracks() {
    if (qualitySelect) qualitySelect.innerHTML = `<option value="-1">Quality: Original</option>`;
    if (subtitleSelect) subtitleSelect.innerHTML = `<option value="-1">Subtitles: Off</option>`;
    if (audioSelect) audioSelect.innerHTML = `<option value="-1">Audio: Default</option>`;
}

function setupPublicHlsControls(hls) {
    resetPublicTracks();
    if (qualitySelect && hls.levels && hls.levels.length) {
        qualitySelect.innerHTML = "";
        const autoOpt = document.createElement("option");
        autoOpt.value = "-1";
        autoOpt.textContent = "Quality: Auto";
        qualitySelect.appendChild(autoOpt);
        hls.levels.forEach((lvl, idx) => {
            const opt = document.createElement("option");
            const label = lvl.height ? `${lvl.height}p` : `${Math.round((lvl.bitrate || 0) / 1000)} kbps`;
            opt.value = String(idx);
            opt.textContent = `Quality: ${label}`;
            qualitySelect.appendChild(opt);
        });
        qualitySelect.onchange = () => {
            hls.currentLevel = parseInt(qualitySelect.value, 10);
        };
    }
    if (audioSelect && hls.audioTracks && hls.audioTracks.length) {
        audioSelect.innerHTML = "";
        hls.audioTracks.forEach((track, idx) => {
            const opt = document.createElement("option");
            opt.value = String(idx);
            opt.textContent = `Audio: ${track.name || track.lang || `Track ${idx + 1}`}`;
            audioSelect.appendChild(opt);
        });
        audioSelect.onchange = () => {
            hls.audioTrack = parseInt(audioSelect.value, 10);
        };
    }
    if (subtitleSelect && hls.subtitleTracks && hls.subtitleTracks.length) {
        subtitleSelect.innerHTML = "";
        const off = document.createElement("option");
        off.value = "-1";
        off.textContent = "Subtitles: Off";
        subtitleSelect.appendChild(off);
        hls.subtitleTracks.forEach((track, idx) => {
            const opt = document.createElement("option");
            opt.value = String(idx);
            opt.textContent = `Subtitles: ${track.name || track.lang || `Track ${idx + 1}`}`;
            subtitleSelect.appendChild(opt);
        });
        subtitleSelect.onchange = () => {
            hls.subtitleTrack = parseInt(subtitleSelect.value, 10);
        };
    }
}

if (player) {
    const hlsUrl = player.dataset.hls;
    if (hlsUrl) {
        fetch(`/s/hls/prepare/${itemId}`, { method: "POST" });
        if (window.Hls && Hls.isSupported()) {
            const hls = new Hls({
                maxBufferLength: 300,
                maxMaxBufferLength: 600,
                maxBufferSize: 120 * 1000 * 1000,
                backBufferLength: 60
            });
            hls.on(Hls.Events.MANIFEST_PARSED, () => setupPublicHlsControls(hls));
            hls.loadSource(hlsUrl);
            hls.attachMedia(player);
        } else if (player.canPlayType("application/vnd.apple.mpegurl")) {
            player.src = hlsUrl;
        }
    } else {
        resetPublicTracks();
    }
    document.getElementById("publicSpeed").addEventListener("change", (e) => {
        player.playbackRate = parseFloat(e.target.value);
    });

    let lastSent = 0;
    player.addEventListener("timeupdate", () => {
        if (!viewerName) return;
        if (player.currentTime - lastSent > 10) {
            lastSent = player.currentTime;
            sendProgress();
        }
    });
    player.addEventListener("pause", sendProgress);
    player.addEventListener("ended", sendProgress);

    async function sendProgress() {
        if (!viewerName) return;
        await fetch("/s/progress", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                token,
                item_id: itemId,
                user_name: viewerName,
                position: player.currentTime || 0,
                duration: player.duration || 0
            })
        });
    }

    async function fetchResume() {
        if (!viewerName) return;
        const res = await fetch(`/s/progress?token=${encodeURIComponent(token)}&item_id=${encodeURIComponent(itemId)}&user=${encodeURIComponent(viewerName)}`);
        const data = await res.json();
        if (data.position && data.position > 5) {
            const shouldResume = confirm("Continue from last time?");
            if (shouldResume) player.currentTime = data.position;
        }
    }
    fetchResume();

    // Double tap skip (mobile-style)
    let lastTap = 0;
    player.addEventListener("pointerup", (e) => {
        if (e.pointerType !== "touch") return;
        const now = Date.now();
        if (now - lastTap < 300) {
            const rect = player.getBoundingClientRect();
            const isLeft = e.clientX < rect.left + rect.width / 2;
            player.currentTime = Math.max(0, player.currentTime + (isLeft ? -10 : 10));
        }
        lastTap = now;
    });

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            player.requestFullscreen?.();
        } else {
            document.exitFullscreen?.();
        }
    }

    document.addEventListener("keydown", (e) => {
        if (e.code === "Space") { e.preventDefault(); player.paused ? player.play() : player.pause(); }
        if (e.code === "ArrowRight") player.currentTime += 10;
        if (e.code === "ArrowLeft") player.currentTime -= 10;
        if (e.key && e.key.toLowerCase() === "f") toggleFullscreen();
    });
}
</script>

{% endblock %}
