{% extends "base.html" %}
{% block content %}

<div id="partyApp" class="min-h-screen bg-gray-900 text-white p-4" data-token="{{ token }}" data-username="{{ viewer_name }}" data-item-id="{{ item.id }}" data-link-token="{{ link_token }}" data-room-code="{{ room_code or '' }}" data-host-name="{{ host_name or '' }}">
  <div id="viewerGate" class="viewer-gate hidden">
    <div class="viewer-card">
      <div class="viewer-title">Who's watching?</div>
      <div class="viewer-sub">Enter your name to join the watch party.</div>
      <input id="viewerInput" type="text" placeholder="Your name" class="viewer-input" />
      <button id="viewerSubmit" class="viewer-btn">Join Party</button>
      <div id="viewerHint" class="viewer-hint"></div>
    </div>
  </div>
  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-4">
    <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
      <div class="bg-gray-900 p-4 border-b border-gray-700 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="fas {{ item.icon }} text-red-500 text-2xl"></i>
          <div>
            <div class="font-bold text-lg truncate max-w-[60vw]">{{ item.name }}</div>
            <div class="text-xs text-gray-400">Watch with friends</div>
          </div>
        </div>
        <div class="text-xs text-gray-400">Party</div>
      </div>

      <div class="bg-black flex justify-center items-center relative">
        {% if "video" in item.mime_type or item.name.lower().endswith(('.mp4', '.mkv', '.webm', '.mov', '.avi')) %}
          <video id="partyPlayer" controls autoplay preload="auto" data-hls="{{ hls_url or '' }}" class="w-full max-h-[70vh] outline-none">
            <source src="{{ stream_url }}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        {% elif "audio" in item.mime_type or item.name.lower().endswith(('.mp3', '.wav', '.ogg', '.m4a')) %}
          <div class="text-center p-10 w-full">
            <audio id="partyPlayer" controls autoplay class="w-full max-w-lg">
              <source src="{{ stream_url }}" type="audio/mpeg">
            </audio>
          </div>
        {% else %}
          <div class="text-center p-10">
            <i class="fas fa-file-archive text-6xl text-gray-600 mb-4"></i>
            <p class="text-gray-400 text-lg">Preview not available</p>
            <p class="text-sm text-gray-500 mb-6">{{ item.formatted_size }}</p>
            <a href="{{ stream_url }}" class="bg-red-600 hover:bg-red-500 text-white px-8 py-3 rounded-full font-bold text-lg transition">Download File</a>
          </div>
        {% endif %}
      </div>

      <div class="bg-gray-900 p-3 border-t border-gray-700 flex flex-wrap gap-2">
        <select id="partyQuality" class="bg-gray-800 border border-gray-700 text-white text-xs rounded px-3 py-2">
          <option value="-1">Quality: Original</option>
        </select>
        <select id="partySubtitle" class="bg-gray-800 border border-gray-700 text-white text-xs rounded px-3 py-2">
          <option value="-1">Subtitles: Off</option>
        </select>
        <select id="partyAudio" class="bg-gray-800 border border-gray-700 text-white text-xs rounded px-3 py-2">
          <option value="-1">Audio: Default</option>
        </select>
      </div>

      {% if episodes %}
      <div class="border-t border-gray-700 bg-gray-900">
        <div class="px-4 py-3 text-xs uppercase tracking-wider text-gray-400 border-b border-gray-800">Episodes</div>
        <div class="p-3 space-y-2 max-h-72 overflow-y-auto">
          {% for ep in episodes %}
            {% set viewer_q = ("&u=" ~ viewer_name) if viewer_name else "" %}
            {% set token_q = ("&t=" ~ link_token) %}
            <a href="/w/{{ token }}?e={{ ep.id }}{{ viewer_q }}{{ token_q }}" class="flex items-center gap-3 p-2 rounded-lg transition border {% if ep.id|string == item.id|string %}bg-gray-800 border-red-500{% else %}bg-gray-900 border-gray-800 hover:border-gray-600{% endif %}">
              <div class="w-9 h-9 rounded bg-gray-800 flex items-center justify-center">
                <i class="fas {{ ep.icon }} text-red-500"></i>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-sm text-white truncate">{{ ep.name }}</div>
                <div class="text-[11px] text-gray-500">{{ ep.formatted_size }}</div>
              </div>
              {% if ep.id|string == item.id|string %}
                <span class="text-[10px] text-red-400 font-semibold">PLAYING</span>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 flex flex-col gap-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Party Status</div>
        <span id="partyRole" class="text-xs bg-gray-900 border border-gray-700 px-2 py-1 rounded">Viewer</span>
      </div>
      <div class="text-sm text-gray-300">
        Host: <span id="partyHost" class="font-semibold">...</span>
      </div>
      <div class="text-sm text-gray-300">
        Room Code: <span id="partyRoomCode" class="font-semibold"></span>
      </div>
      <div class="text-sm text-gray-300">
        Join Link:
        <div class="mt-2 flex gap-2">
          <input id="partyJoinLink" type="text" readonly class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-200 font-mono">
          <button id="copyJoinLink" class="bg-blue-600 hover:bg-blue-500 text-white px-3 rounded-lg text-xs font-bold">Copy</button>
        </div>
      </div>
      <div class="text-sm text-gray-300">
        Members:
        <div id="partyMembers" class="mt-2 text-xs text-gray-400">Loading...</div>
      </div>
      <div class="text-sm text-gray-300">
        Chat:
        <div id="partyChat" class="mt-2 bg-gray-900 border border-gray-700 rounded-lg p-2 h-48 overflow-y-auto text-xs text-gray-200"></div>
        <div class="mt-2 flex gap-2">
          <input id="partyChatInput" type="text" placeholder="Type a message..." class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-200">
          <button id="partyChatSend" class="bg-blue-600 hover:bg-blue-500 text-white px-3 rounded-lg text-xs font-bold">Send</button>
        </div>
      </div>
      <div id="partyLag" class="text-xs text-gray-400">Syncing...</div>
      <button id="resyncBtn" class="hidden bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded text-sm font-bold">Re-sync</button>
      <div id="episodePrompt" class="hidden text-xs text-yellow-400"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  .viewer-gate {
    position: fixed;
    inset: 0;
    background: rgba(5, 6, 12, 0.92);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 60;
    backdrop-filter: blur(10px);
  }
  .viewer-gate.hidden { display: none; }
  .viewer-card {
    width: min(420px, 90vw);
    background: rgba(17, 24, 39, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 18px;
    padding: 24px;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
  }
  .viewer-title { font-size: 20px; font-weight: 700; color: #fff; }
  .viewer-sub { margin-top: 8px; font-size: 13px; color: #9aa4b2; }
  .viewer-input {
    margin-top: 16px;
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: rgba(5, 8, 18, 0.9);
    color: #fff;
    font-size: 14px;
  }
  .viewer-btn {
    width: 100%;
    justify-content: center;
    margin-top: 12px;
    padding: 10px 18px;
    border-radius: 999px;
    font-weight: 700;
    font-size: 13px;
    background: #e50914;
    color: #fff;
    border: none;
    cursor: pointer;
  }
  .viewer-hint { margin-top: 10px; font-size: 12px; color: #9aa4b2; }
</style>

<script>
const partyApp = document.getElementById("partyApp");
const token = partyApp.dataset.token;
const viewerName = partyApp.dataset.username;
const itemId = partyApp.dataset.itemId;
const linkToken = partyApp.dataset.linkToken;
let roomCode = partyApp.dataset.roomCode || "";

const player = document.getElementById("partyPlayer");
const partyQuality = document.getElementById("partyQuality");
const partySubtitle = document.getElementById("partySubtitle");
const partyAudio = document.getElementById("partyAudio");
const resyncBtn = document.getElementById("resyncBtn");
const partyLag = document.getElementById("partyLag");
const viewerGate = document.getElementById("viewerGate");
const viewerInput = document.getElementById("viewerInput");
const viewerSubmit = document.getElementById("viewerSubmit");
const partyHost = document.getElementById("partyHost");
const partyRoomCode = document.getElementById("partyRoomCode");
const partyJoinLink = document.getElementById("partyJoinLink");
const copyJoinLink = document.getElementById("copyJoinLink");
const partyMembers = document.getElementById("partyMembers");
const partyChat = document.getElementById("partyChat");
const partyChatInput = document.getElementById("partyChatInput");
const partyChatSend = document.getElementById("partyChatSend");
const partyRole = document.getElementById("partyRole");
const episodePrompt = document.getElementById("episodePrompt");

let isHost = false;
let hostState = null;

function updateJoinInfo() {
  if (!roomCode) return;
  partyRoomCode.textContent = roomCode;
  const base = window.location.origin;
  const joinUrl = `${base}/w/${token}?t=${encodeURIComponent(linkToken)}&room=${encodeURIComponent(roomCode)}`;
  partyJoinLink.value = joinUrl;
}

function setSelectState(select, enabled) {
  if (!select) return;
  select.disabled = !enabled;
  select.classList.toggle("opacity-50", !enabled);
}

function resetPartyTracks() {
  if (partyQuality) partyQuality.innerHTML = `<option value="-1">Quality: Original</option>`;
  if (partySubtitle) partySubtitle.innerHTML = `<option value="-1">Subtitles: Off</option>`;
  if (partyAudio) partyAudio.innerHTML = `<option value="-1">Audio: Default</option>`;
  setSelectState(partyQuality, false);
  setSelectState(partySubtitle, false);
  setSelectState(partyAudio, false);
}

function setupPartyHlsControls(hls) {
  resetPartyTracks();
  if (partyQuality && hls.levels && hls.levels.length) {
    partyQuality.innerHTML = "";
    const autoOpt = document.createElement("option");
    autoOpt.value = "-1";
    autoOpt.textContent = "Quality: Auto";
    partyQuality.appendChild(autoOpt);
    hls.levels.forEach((lvl, idx) => {
      const opt = document.createElement("option");
      const label = lvl.height ? `${lvl.height}p` : `${Math.round((lvl.bitrate || 0) / 1000)} kbps`;
      opt.value = String(idx);
      opt.textContent = `Quality: ${label}`;
      partyQuality.appendChild(opt);
    });
    partyQuality.onchange = () => {
      const v = parseInt(partyQuality.value, 10);
      hls.currentLevel = Number.isNaN(v) ? -1 : v;
    };
    const current = typeof hls.currentLevel === "number" ? hls.currentLevel : -1;
    partyQuality.value = String(current);
    setSelectState(partyQuality, true);
  }
  if (partyAudio && hls.audioTracks && hls.audioTracks.length) {
    partyAudio.innerHTML = "";
    const defOpt = document.createElement("option");
    defOpt.value = "-1";
    defOpt.textContent = "Audio: Default";
    partyAudio.appendChild(defOpt);
    hls.audioTracks.forEach((track, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `Audio: ${track.name || track.lang || `Track ${idx + 1}`}`;
      partyAudio.appendChild(opt);
    });
    partyAudio.onchange = () => {
      const v = parseInt(partyAudio.value, 10);
      hls.audioTrack = v < 0 || Number.isNaN(v) ? 0 : v;
    };
    const current = typeof hls.audioTrack === "number" ? hls.audioTrack : 0;
    partyAudio.value = String(current);
    setSelectState(partyAudio, true);
  }
  if (partySubtitle && hls.subtitleTracks && hls.subtitleTracks.length) {
    partySubtitle.innerHTML = "";
    const off = document.createElement("option");
    off.value = "-1";
    off.textContent = "Subtitles: Off";
    partySubtitle.appendChild(off);
    hls.subtitleTracks.forEach((track, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `Subtitles: ${track.name || track.lang || `Track ${idx + 1}`}`;
      partySubtitle.appendChild(opt);
    });
    partySubtitle.onchange = () => {
      const v = parseInt(partySubtitle.value, 10);
      hls.subtitleTrack = Number.isNaN(v) ? -1 : v;
    };
    const current = typeof hls.subtitleTrack === "number" ? hls.subtitleTrack : -1;
    partySubtitle.value = String(current);
    setSelectState(partySubtitle, true);
  }
}

function setupPartyNativeTracks(playerEl) {
  if (!playerEl) return;
  if (partyQuality) {
    partyQuality.innerHTML = `<option value="-1">Quality: Auto</option>`;
    setSelectState(partyQuality, false);
  }
  if (partyAudio) {
    const tracks = playerEl.audioTracks ? Array.from(playerEl.audioTracks) : [];
    if (tracks.length) {
      partyAudio.innerHTML = "";
      const defOpt = document.createElement("option");
      defOpt.value = "-1";
      defOpt.textContent = "Audio: Default";
      partyAudio.appendChild(defOpt);
      tracks.forEach((t, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = `Audio: ${t.label || t.language || `Track ${idx + 1}`}`;
        partyAudio.appendChild(opt);
      });
      partyAudio.onchange = () => {
        const v = parseInt(partyAudio.value, 10);
        const target = v < 0 || Number.isNaN(v) ? 0 : v;
        tracks.forEach((t, idx) => { t.enabled = idx === target; });
      };
      const enabledIdx = tracks.findIndex(t => t.enabled);
      partyAudio.value = String(enabledIdx >= 0 ? enabledIdx : 0);
      setSelectState(partyAudio, true);
    } else {
      partyAudio.innerHTML = `<option value="-1">Audio: Default</option>`;
      setSelectState(partyAudio, false);
    }
  }
  if (partySubtitle) {
    const tracks = playerEl.textTracks ? Array.from(playerEl.textTracks).filter(t => t.kind === "subtitles" || t.kind === "captions") : [];
    if (tracks.length) {
      partySubtitle.innerHTML = "";
      const off = document.createElement("option");
      off.value = "-1";
      off.textContent = "Subtitles: Off";
      partySubtitle.appendChild(off);
      tracks.forEach((t, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = `Subtitles: ${t.label || t.language || `Track ${idx + 1}`}`;
        partySubtitle.appendChild(opt);
      });
      partySubtitle.onchange = () => {
        const v = parseInt(partySubtitle.value, 10);
        if (Number.isNaN(v) || v < 0) {
          tracks.forEach(t => { t.mode = "disabled"; });
        } else {
          tracks.forEach((t, idx) => { t.mode = idx === v ? "showing" : "disabled"; });
        }
      };
      setSelectState(partySubtitle, true);
    } else {
      partySubtitle.innerHTML = `<option value="-1">Subtitles: Off</option>`;
      setSelectState(partySubtitle, false);
    }
  }
}

if (copyJoinLink) {
  copyJoinLink.addEventListener("click", () => {
    partyJoinLink.select();
    document.execCommand("copy");
  });
}

async function joinParty() {
  const res = await fetch("/w/party/join", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ token, user_name: viewerName })
  });
  const data = await res.json();
  if (data.role) {
    isHost = data.role === "host";
    partyRole.textContent = isHost ? "Host" : "Viewer";
    partyHost.textContent = data.host_name || viewerName;
    if (data.room_code) {
      roomCode = data.room_code;
      updateJoinInfo();
    }
  }
}

async function fetchMembers() {
  const res = await fetch(`/w/party/members?token=${encodeURIComponent(token)}`);
  const data = await res.json();
  if (!data.members || data.members.length === 0) {
    partyMembers.textContent = "No members yet.";
  } else {
    partyMembers.textContent = data.members.join(", ");
  }
}

async function fetchChat() {
  const res = await fetch(`/w/party/chat?token=${encodeURIComponent(token)}`);
  const data = await res.json();
  if (!data.messages) return;
  partyChat.innerHTML = data.messages.map(m => `<div><span class="text-gray-400">${m.user}:</span> ${m.text}</div>`).join("");
  partyChat.scrollTop = partyChat.scrollHeight;
}

async function sendChat() {
  const text = (partyChatInput?.value || "").trim();
  if (!text) return;
  partyChatInput.value = "";
  await fetch("/w/party/chat", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ token, user_name: viewerName, text })
  });
  fetchChat();
}

partyChatSend?.addEventListener("click", sendChat);
partyChatInput?.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendChat();
  }
});

async function fetchHostState() {
  const res = await fetch(`/w/party/state?token=${encodeURIComponent(token)}`);
  const data = await res.json();
  if (data.host_name) {
    hostState = data;
    partyHost.textContent = data.host_name;
    if (data.room_code) {
      roomCode = data.room_code;
      updateJoinInfo();
    }
    updateLagUI();
    maybePromptEpisode();
    applyHostSync();
  }
}

function updateLagUI() {
  if (!player || !hostState) return;
  const lag = (hostState.position || 0) - (player.currentTime || 0);
  if (!isHost && lag > 15) {
    resyncBtn.classList.remove("hidden");
    partyLag.textContent = `You are behind by ${Math.round(lag)}s`;
  } else {
    resyncBtn.classList.add("hidden");
    partyLag.textContent = "In sync";
  }
}

function applyHostSync() {
  if (!hostState || !player || isHost) return;
  if (hostState.item_id && hostState.item_id !== itemId) {
    const url = `/w/${token}?e=${encodeURIComponent(hostState.item_id)}&u=${encodeURIComponent(viewerName)}&t=${encodeURIComponent(linkToken)}${roomCode ? `&room=${encodeURIComponent(roomCode)}` : ""}`;
    window.location.href = url;
    return;
  }
  const drift = (hostState.position || 0) - (player.currentTime || 0);
  if (Math.abs(drift) > 2) {
    player.currentTime = hostState.position || 0;
  }
  if (hostState.is_playing && player.paused) {
    player.play?.();
  }
  if (!hostState.is_playing && !player.paused) {
    player.pause?.();
  }
}

function maybePromptEpisode() {
  if (!hostState || isHost) return;
  if (hostState.item_id && hostState.item_id !== itemId) {
    const url = `/w/${token}?e=${encodeURIComponent(hostState.item_id)}&u=${encodeURIComponent(viewerName)}&t=${encodeURIComponent(linkToken)}`;
    episodePrompt.classList.remove("hidden");
    episodePrompt.innerHTML = `Host switched episode. <a class="underline" href="${url}">Join host episode</a>`;
  } else {
    episodePrompt.classList.add("hidden");
  }
}

async function pushHostState() {
  if (!isHost || !player) return;
  await fetch("/w/party/state", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      token,
      user_name: viewerName,
      position: player.currentTime || 0,
      item_id: itemId,
      is_playing: !player.paused
    })
  });
}

if (player) {
  player.addEventListener("play", pushHostState);
  player.addEventListener("pause", pushHostState);
  player.addEventListener("seeked", pushHostState);
}

if (resyncBtn) {
  resyncBtn.addEventListener("click", () => {
    if (hostState && player) {
      player.currentTime = hostState.position || 0;
      player.play?.();
      updateLagUI();
    }
  });
}

function openViewerGate() {
  if (!viewerGate) return;
  viewerGate.classList.remove("hidden");
  viewerInput?.focus();
}

if (!viewerName) {
  openViewerGate();
}

viewerSubmit?.addEventListener("click", () => {
    const raw = (viewerInput?.value || "").trim();
    if (!raw) return;
    const roomPart = roomCode ? `&room=${encodeURIComponent(roomCode)}` : "";
    window.location.href = `/w/${token}?u=${encodeURIComponent(raw)}&t=${encodeURIComponent(linkToken)}${roomPart}`;
});

if (player) {
  const hlsUrl = player.dataset.hls;
  if (hlsUrl) {
    fetch(`/s/hls/prepare/${itemId}`, { method: "POST" });
    if (window.Hls && Hls.isSupported()) {
      const hls = new Hls({
        maxBufferLength: 90,
        maxMaxBufferLength: 180,
        maxBufferSize: 80 * 1000 * 1000,
        backBufferLength: 60,
        maxBufferHole: 0.2,
        startFragPrefetch: true
      });
      const refreshTracks = () => setupPartyHlsControls(hls);
      hls.on(Hls.Events.MANIFEST_PARSED, refreshTracks);
      hls.on(Hls.Events.LEVELS_UPDATED, refreshTracks);
      hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, refreshTracks);
      hls.on(Hls.Events.SUBTITLE_TRACKS_UPDATED, refreshTracks);
      hls.on(Hls.Events.LEVEL_SWITCHED, () => {
        if (partyQuality) partyQuality.value = String(hls.currentLevel);
      });
      hls.loadSource(hlsUrl);
      hls.attachMedia(player);
    } else if (player.canPlayType("application/vnd.apple.mpegurl")) {
      player.src = hlsUrl;
      player.addEventListener("loadedmetadata", () => setupPartyNativeTracks(player));
    }
  } else {
    resetPartyTracks();
  }
}

if (partyApp.dataset.hostName) {
  partyHost.textContent = partyApp.dataset.hostName;
}
updateJoinInfo();

if (viewerName) {
  joinParty().then(() => {
    fetchHostState();
    fetchMembers();
    fetchChat();
    setInterval(fetchHostState, 3000);
    setInterval(pushHostState, 2000);
    setInterval(fetchMembers, 5000);
    setInterval(fetchChat, 3000);
    setInterval(() => {
      fetch("/w/party/ping", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ token, user_name: viewerName })
      });
    }, 10000);
  });
}
</script>

{% endblock %}
