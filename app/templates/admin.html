
{% extends "admin_base.html" %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Main Control</h1>
                <div class="admin-section-note">Manage movies and web series, publish catalog, and review activity.</div>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-dark">
                    <div class="inner">
                        <h3>{{ published_movies or 0 }}</h3>
                        <p>Published Movies</p>
                    </div>
                    <div class="icon"><i class="fas fa-film"></i></div>
                    <a href="#published-catalog" class="small-box-footer">View <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-dark">
                    <div class="inner">
                        <h3>{{ published_series or 0 }}</h3>
                        <p>Published Series</p>
                    </div>
                    <div class="icon"><i class="fas fa-tv"></i></div>
                    <a href="#published-catalog" class="small-box-footer">View <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-dark">
                    <div class="inner">
                        <h3>{{ pending_storage or 0 }}</h3>
                        <p>Storage Pending</p>
                    </div>
                    <div class="icon"><i class="fas fa-magic"></i></div>
                    <a href="/dashboard/add-content" class="small-box-footer">Manage <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-dark">
                    <div class="inner">
                        <h3>{{ total_files or 0 }}</h3>
                        <p>Total Files</p>
                    </div>
                    <div class="icon"><i class="fas fa-database"></i></div>
                    <a href="/storage" class="small-box-footer">Open Storage <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="card card-outline card-info">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-key"></i> Link Token</h3>
                        <div class="card-tools">
                            <button type="button" onclick="navigator.clipboard.writeText('{{ link_token }}')" class="btn btn-sm btn-primary">Copy</button>
                            <form action="/admin/token/regenerate" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Regenerate token? All share links need updated t= value.')">Regenerate</button>
                            </form>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="text-muted text-sm">Current token</div>
                        <div class="font-weight-bold text-monospace">{{ link_token or 'not-set' }}</div>
                        <div class="admin-section-note mt-2">Copy this value when creating share links.</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card card-outline card-warning">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-database"></i> TMDB Metadata</h3>
                        <div class="card-tools">
                            <form action="/admin/tmdb/refresh" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-warning" {% if not tmdb_configured %}disabled{% endif %}>
                                    Refresh TMDB Metadata
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if tmdb_configured %}
                            <span class="badge badge-success">TMDB_API_KEY configured</span>
                        {% else %}
                            <span class="badge badge-danger">TMDB_API_KEY missing</span>
                            <div class="admin-section-note mt-2">Set it in `.env` (local) or Render Environment Variables.</div>
                        {% endif %}
                        {% if tmdb_status == "refresh_started" %}
                            <div class="admin-section-note mt-2 text-warning">Refresh started. Check a content page in 1-2 minutes.</div>
                        {% elif tmdb_status == "missing" %}
                            <div class="admin-section-note mt-2 text-danger">Cannot refresh without TMDB_API_KEY.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="card card-outline card-primary" id="published-catalog">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-film"></i> Published Catalog</h3>
                <div class="card-tools">
                    <span class="badge badge-info">Visible on Home and Content pages</span>
                </div>
            </div>
            <div class="card-body">
                {% if published_groups and published_groups|length > 0 %}
                    {% for group in published_groups %}
                    <form id="update-form-{{ loop.index0 }}" action="/dashboard/update-metadata" method="post" class="card card-outline card-dark mb-4">
                        <input type="hidden" name="group_title" value="{{ group.title }}">
                        <input type="hidden" name="group_year" value="{{ group.year }}">
                        <input type="hidden" name="group_type" value="{{ group.type }}">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-folder"></i> {{ group.title }}
                                <span class="badge badge-secondary ml-2">{{ group.type|title }}</span>
                                {% if group.year %}<span class="badge badge-light ml-1">{{ group.year }}</span>{% endif %}
                            </h3>
                            <div class="card-tools">
                                <button type="submit" class="btn btn-sm btn-primary">Update Metadata</button>
                                <button form="delete-form-{{ loop.index0 }}" type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this catalog group?')">Delete</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label>Title</label>
                                    <input name="title" value="{{ group.title }}" class="form-control" />
                                </div>
                                <div class="form-group col-md-2">
                                    <label>Type</label>
                                    <input value="{{ group.type }}" class="form-control" readonly />
                                </div>
                                <div class="form-group col-md-2">
                                    <label>Year</label>
                                    <input name="year" value="{{ group.year }}" class="form-control" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label>Description</label>
                                    <textarea name="description" rows="3" class="form-control"></textarea>
                                </div>
                                <div class="form-group col-md-6">
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>Genres (comma)</label>
                                            <input name="genres" class="form-control" />
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label>Director</label>
                                            <input name="director" class="form-control" />
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label>Actors (comma)</label>
                                            <input name="actors" class="form-control" />
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label>Trailer URL</label>
                                            <input name="trailer_url" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row text-sm">
                                <div class="col-md-3"><strong>Files:</strong> {{ group.file_count }}</div>
                                <div class="col-md-3"><strong>Total Size:</strong> {{ group.total_size_label }}</div>
                                <div class="col-md-6"><strong>Qualities:</strong> {{ group.qualities|join(", ") if group.qualities else "-" }}</div>
                            </div>
                            {% if group.type == 'series' and group.seasons %}
                            <div class="mt-2">
                                {% for season in group.seasons %}
                                    <span class="badge badge-dark mr-1">S{{ season.season }} · {{ season.episode_count }} eps{% if season.qualities %} · {{ season.qualities|join("/") }}{% endif %}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <details class="mt-3">
                                <summary class="text-muted">Show files ({{ group.file_count }})</summary>
                                <div class="table-responsive mt-2">
                                    <table class="table table-sm table-dark mb-0">
                                        <thead>
                                            <tr>
                                                <th>File</th>
                                                <th>Quality</th>
                                                <th>Season/Episode</th>
                                                <th class="text-right">Size</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in group['items'] %}
                                            <tr>
                                                <td class="text-truncate" style="max-width: 260px;" title="{{ item.name }}">{{ item.name }}</td>
                                                <td>{{ item.quality or '-' }}</td>
                                                <td>
                                                    {% if group.type == 'series' %}
                                                        S{{ item.season or '?' }}E{{ item.episode or '?' }}
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                                <td class="text-right">{{ item.size_label }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </details>
                        </div>
                    </form>
                    <form id="delete-form-{{ loop.index0 }}" action="/dashboard/delete" method="post" class="d-none">
                        <input type="hidden" name="group_title" value="{{ group.title }}">
                        <input type="hidden" name="group_type" value="{{ group.type }}">
                    </form>
                    {% endfor %}
                {% else %}
                    <div class="admin-section-note">No published catalog yet.</div>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-lg-7">
                <div class="card card-outline card-secondary">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-robot"></i> Bot Pool Health</h3>
                        <div class="card-tools">
                            <span class="badge badge-info">Live check</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-dark mb-0">
                                <thead>
                                    <tr>
                                        <th>Bot</th>
                                        <th>Status</th>
                                        <th>Detail</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for b in bots %}
                                    <tr>
                                        <td class="text-monospace">{{ b.label }}</td>
                                        <td>
                                            {% if b.ok %}
                                                <span class="badge badge-success">OK</span>
                                            {% else %}
                                                <span class="badge badge-danger">FAIL</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-muted">{{ b.detail }}</td>
                                    </tr>
                                    {% else %}
                                    <tr><td colspan="3" class="text-center text-muted">No bots configured</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="card card-outline card-info">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-sliders-h"></i> Bot Controls</h3>
                    </div>
                    <div class="card-body">
                        <form action="/admin/bots/update_tokens" method="post">
                            <div class="form-group">
                                <label>Pool Tokens (comma or newline)</label>
                                <textarea name="bot_tokens" rows="3" class="form-control" placeholder="123:ABC, 456:DEF">{{ pool_tokens }}</textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Save & Reload Pool</button>
                        </form>
                        <hr />
                        <form action="/admin/bots/speedtest" method="post">
                            <div class="form-group">
                                <label><i class="fas fa-tachometer-alt"></i> Speed Test (downloads ~1MB)</label>
                            </div>
                            <button type="submit" class="btn btn-success btn-block">Run Speed Test</button>
                            {% if speed_result %}
                                {% if speed_result.ok %}
                                    <div class="admin-section-note mt-2">~{{ (speed_result.mb_per_s or 0)|round(2) }} MB/s ({{ (speed_result.bytes/1024/1024)|round(2) }} MB in {{ speed_result.seconds|round(2) }}s)</div>
                                {% else %}
                                    <div class="admin-section-note mt-2 text-danger">Failed: {{ speed_result.error }}</div>
                                {% endif %}
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="card card-outline card-warning">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-palette"></i> Site Settings</h3>
                <div class="card-tools">
                    <span class="badge badge-warning">Theme & Hero</span>
                </div>
            </div>
            <div class="card-body">
                <form action="/admin/site/save" method="post">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>Site Name</label>
                            <input name="site_name" value="{{ site.site_name if site else 'mysticmovies' }}" class="form-control" />
                        </div>
                        <div class="form-group col-md-6">
                            <label>Accent Color</label>
                            <input name="accent_color" value="{{ site.accent_color if site else '#facc15' }}" class="form-control" />
                        </div>
                        <div class="form-group col-md-6">
                            <label>Background Color</label>
                            <input name="bg_color" value="{{ site.bg_color if site else '#070b12' }}" class="form-control" />
                        </div>
                        <div class="form-group col-md-6">
                            <label>Card Color</label>
                            <input name="card_color" value="{{ site.card_color if site else '#111827' }}" class="form-control" />
                        </div>
                        <div class="form-group col-md-12">
                            <label>Hero Title</label>
                            <input name="hero_title" value="{{ site.hero_title if site else '' }}" class="form-control" />
                        </div>
                        <div class="form-group col-md-12">
                            <label>Hero Subtitle</label>
                            <input name="hero_subtitle" value="{{ site.hero_subtitle if site else '' }}" class="form-control" />
                        </div>
                        <div class="form-group col-md-6">
                            <label>Hero CTA Text</label>
                            <input name="hero_cta_text" value="{{ site.hero_cta_text if site else 'Browse Content' }}" class="form-control" />
                        </div>
                        <div class="form-group col-md-6">
                            <label>Hero CTA Link</label>
                            <input name="hero_cta_link" value="{{ site.hero_cta_link if site else '/content' }}" class="form-control" />
                        </div>
                        <div class="form-group col-md-12">
                            <label>Footer Text</label>
                            <input name="footer_text" value="{{ site.footer_text if site else 'MysticMovies' }}" class="form-control" />
                        </div>
                    </div>
                    <button class="btn btn-warning">Save Site Settings</button>
                </form>
            </div>
        </div>
        <div class="card card-outline card-info">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-inbox"></i> Content Requests</h3>
                <div class="card-tools">
                    <span class="badge badge-info">User Requests</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-dark mb-0">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Type</th>
                                <th>Title</th>
                                <th>Note</th>
                                <th class="text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in pending_content_requests %}
                            <tr>
                                <td class="text-xs">{{ r.user_phone }}</td>
                                <td class="text-uppercase">{{ r.request_type }}</td>
                                <td>{{ r.title }}</td>
                                <td class="text-muted">{{ r.note or '-' }}</td>
                                <td class="text-right">
                                    <form action="/admin/request/{{ r.id }}/fulfilled" method="post" class="d-inline">
                                        <button class="btn btn-sm btn-success">Fulfilled</button>
                                    </form>
                                    <form action="/admin/request/{{ r.id }}/rejected" method="post" class="d-inline">
                                        <button class="btn btn-sm btn-danger">Reject</button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center text-muted">No pending requests</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="card card-outline card-secondary">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-tags"></i> Catalog Metadata</h3>
                <div class="card-tools">
                    <span class="badge badge-secondary">Tag Movies or Series</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-dark mb-0">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Type</th>
                                <th>Series/Season/Episode</th>
                                <th>Quality</th>
                                <th class="text-right">Save</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in content_items %}
                            <tr>
                                <form action="/admin/content/update" method="post">
                                    <input type="hidden" name="item_id" value="{{ item.id }}">
                                    <td class="text-truncate" style="max-width: 240px;" title="{{ item.name }}">{{ item.name }}</td>
                                    <td>
                                        <select name="catalog_type" class="custom-select custom-select-sm">
                                            <option value="movie" {% if item.catalog_type == "movie" %}selected{% endif %}>Movie</option>
                                            <option value="series" {% if item.catalog_type == "series" %}selected{% endif %}>Series</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input name="series_title" value="{{ item.series_title or '' }}" placeholder="Series title" class="form-control form-control-sm mb-1">
                                        <div class="form-row">
                                            <div class="col">
                                                <input name="season" value="{{ item.season or '' }}" placeholder="S" class="form-control form-control-sm">
                                            </div>
                                            <div class="col">
                                                <input name="episode" value="{{ item.episode or '' }}" placeholder="E" class="form-control form-control-sm">
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <input name="quality" value="{{ item.quality or '' }}" placeholder="1080P" class="form-control form-control-sm">
                                    </td>
                                    <td class="text-right">
                                        <button class="btn btn-sm btn-primary">Save</button>
                                    </td>
                                    <input type="hidden" name="title" value="{{ item.title or '' }}">
                                    <input type="hidden" name="description" value="{{ item.description or '' }}">
                                    <input type="hidden" name="year" value="{{ item.year or '' }}">
                                    <input type="hidden" name="genres" value="{{ (item.genres or [])|join(',') }}">
                                    <input type="hidden" name="actors" value="{{ (item.actors or [])|join(',') }}">
                                    <input type="hidden" name="director" value="{{ item.director or '' }}">
                                    <input type="hidden" name="trailer_url" value="{{ item.trailer_url or '' }}">
                                </form>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center text-muted">No files found</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="info-box bg-dark">
                    <span class="info-box-icon bg-info"><i class="fas fa-users"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Total Users</span>
                        <span class="info-box-number">{{ total_users }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-box bg-dark">
                    <span class="info-box-icon bg-warning"><i class="fas fa-file-archive"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Total Files</span>
                        <span class="info-box-number">{{ total_files }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-box bg-dark">
                    <span class="info-box-icon bg-danger"><i class="fas fa-server"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Database</span>
                        <span class="info-box-number">MongoDB</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="card card-outline card-warning">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-user-check"></i> Pending Requests</h3>
                <div class="card-tools">
                    <span class="badge badge-warning">Approval Needed</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-dark mb-0">
                        <thead>
                            <tr>
                                <th>Phone Number</th>
                                <th>Requested Name</th>
                                <th>Requested At</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in pending_users %}
                            <tr>
                                <td>{{ user.phone_number }}</td>
                                <td>{{ user.requested_name or user.first_name or "User" }}</td>
                                <td>{{ user.requested_at.strftime('%Y-%m-%d') if user.requested_at else '-' }}</td>
                                <td class="text-right">
                                    <form action="/admin/approve_user" method="post" class="d-inline">
                                        <input type="hidden" name="user_phone" value="{{ user.phone_number }}">
                                        <button type="submit" class="btn btn-sm btn-success">Approve</button>
                                    </form>
                                    <form action="/admin/block_user" method="post" class="d-inline">
                                        <input type="hidden" name="user_phone" value="{{ user.phone_number }}">
                                        <button type="submit" class="btn btn-sm btn-secondary">Block</button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center text-muted">No pending requests</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="card card-outline card-danger">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-database"></i> User Database</h3>
                <div class="card-tools">
                    <span class="badge badge-danger">Restricted Access</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-dark mb-0">
                        <thead>
                            <tr>
                                <th>Phone Number</th>
                                <th>Status</th>
                                <th>Joined Date</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.phone_number }}</td>
                                <td>
                                    {% if user.status == "approved" %}
                                        <span class="badge badge-success">APPROVED</span>
                                    {% elif user.status == "pending" %}
                                        <span class="badge badge-warning">PENDING</span>
                                    {% else %}
                                        <span class="badge badge-secondary">BLOCKED</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                <td class="text-right">
                                    <form action="/admin/block_user" method="post" class="d-inline">
                                        <input type="hidden" name="user_phone" value="{{ user.phone_number }}">
                                        <button type="submit" class="btn btn-sm btn-secondary">Block</button>
                                    </form>
                                    <form action="/admin/delete_user" method="post" class="d-inline">
                                        <input type="hidden" name="user_phone" value="{{ user.phone_number }}">
                                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="card card-outline card-info">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-chart-line"></i> Recent Playback Analytics</h3>
                <div class="card-tools">
                    <span class="badge badge-info">Last 50 Events</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-dark mb-0">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Type</th>
                                <th>Item</th>
                                <th>Progress</th>
                                <th>Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in recent_progress %}
                            <tr>
                                <td>{{ p.user_key }}</td>
                                <td class="text-uppercase">{{ p.user_type }}</td>
                                <td>{{ items_map.get(p.item_id, p.item_id) }}</td>
                                <td>
                                    {% if p.duration > 0 %}
                                        {{ ((p.position / p.duration) * 100) | round(1) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                                <td>{{ p.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center text-muted">No analytics yet</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block page_scripts %}
<script>
document.querySelectorAll(".tmdb-fetch").forEach(function (btn) {
    btn.addEventListener("click", async function () {
        var id = btn.dataset.group;
        var titleEl = document.getElementById("title-" + id);
        var typeEl = document.getElementById("type-" + id);
        var yearEl = document.getElementById("year-" + id);
        var descEl = document.getElementById("desc-" + id);
        var genresEl = document.getElementById("genres-" + id);
        var actorsEl = document.getElementById("actors-" + id);
        var directorEl = document.getElementById("director-" + id);
        var trailerEl = document.getElementById("trailer-" + id);
        if (!titleEl || !typeEl) return;
        var q = titleEl.value.trim();
        var contentType = typeEl.value;
        if (!q) return;
        btn.disabled = true;
        btn.textContent = "Fetching...";
        try {
            var res = await fetch("/dashboard/tmdb/lookup?q=" + encodeURIComponent(q) + "&content_type=" + encodeURIComponent(contentType));
            var data = await res.json();
            if (!data.ok) {
                alert(data.error || "TMDB fetch failed");
            } else {
                if (data.title && titleEl) titleEl.value = data.title;
                if (data.year && yearEl) yearEl.value = data.year;
                if (data.description && descEl) descEl.value = data.description;
                if (data.genres && genresEl) genresEl.value = data.genres.join(", ");
                if (data.actors && actorsEl) actorsEl.value = data.actors.join(", ");
                if (data.director && directorEl) directorEl.value = data.director;
                if (data.trailer_url && trailerEl) trailerEl.value = data.trailer_url;
            }
        } catch (e) {
            alert("TMDB fetch failed");
        } finally {
            btn.disabled = false;
            btn.textContent = "Auto Fetch TMDB";
        }
    });
});
</script>
{% endblock %}
